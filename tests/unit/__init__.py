
from nbgrader_to_canvas.canvas import CanvasWrapper
from nbgrader_to_canvas import db
import time
from nbgrader_to_canvas.models import AssignmentStatus

# Test data for test_canvas


class FakeResponse:
    def __init__(self,headers, status_code):
        self.headers = headers
        self.status_code = status_code
class FakeProgress:
    def __init__(self, url):
        self.url = url


# Test data for test_upload_grades
canvas_students = {'testacct111': 114217, 'testacct222': 115752, 'testacct333': 115753, 'dta001': 3597, 'mdandrad': 54, 'matthewf': 53, 'pjamason': 52, 'jdkindley': 139640, 'nb2canvas_student1': 141753, 'nb2canvas_student2': 141754, 'nb2canvas_student3': 141755, 'nb2canvas_student4': 141756, 'nb2canvas_student5': 141757, 'nb2canvas_student6': 141758, 'nb2canvas_student7': 141759, 'nb2canvas_student8': 141760, 'nb2canvas_student9': 141761, 'nb2canvas_student10': 141762, 'nb2canvas_student11': 141763, 'nb2canvas_student12': 141764, 'nb2canvas_student13': 141765, 'nb2canvas_student14': 141766, 'nb2canvas_student15': 141767, 'nb2canvas_student16': 141768, 'nb2canvas_student17': 141769, 'nb2canvas_student18': 141770, 'nb2canvas_student19': 141771, 'nb2canvas_student20': 141772, 'nb2canvas_student21': 141773, 'nb2canvas_student22': 141774, 'nb2canvas_student23': 141775, 'nb2canvas_student24': 141776, 'nb2canvas_student25': 141777, 'nb2canvas_student26': 141778, 'nb2canvas_student27': 141779, 'nb2canvas_student28': 141780, 'nb2canvas_student29': 141781, 'nb2canvas_student30': 141782, 'nb2canvas_student31': 141783, 'nb2canvas_student32': 141784, 'nb2canvas_student33': 141785, 'nb2canvas_student34': 141786, 'nb2canvas_student35': 141787, 'nb2canvas_student36': 141788, 'nb2canvas_student37': 141789, 'nb2canvas_student38': 141790, 'nb2canvas_student39': 141791, 'nb2canvas_student40': 141792, 'nb2canvas_student41': 141793, 'nb2canvas_student42': 141794, 'nb2canvas_student43': 141795, 'nb2canvas_student44': 141796, 'nb2canvas_student45': 141797, 'nb2canvas_student46': 141798, 'nb2canvas_student47': 141799, 'nb2canvas_student48': 141800, 'nb2canvas_student49': 141801, 'nb2canvas_student50': 141802, 'nb2canvas_student51': 141803, 'nb2canvas_student52': 141804, 'nb2canvas_student53': 141805, 'nb2canvas_student54': 141806, 'nb2canvas_student55': 141807, 'nb2canvas_student56': 141808, 'nb2canvas_student57': 141809, 'nb2canvas_student58': 141810, 'nb2canvas_student59': 141811, 'nb2canvas_student60': 141812, 'nb2canvas_student61': 141813, 'nb2canvas_student62': 141814, 'nb2canvas_student63': 141815, 'nb2canvas_student64': 141816, 'nb2canvas_student65': 141817, 'nb2canvas_student66': 141818, 'nb2canvas_student67': 141819, 'nb2canvas_student68': 141820, 'nb2canvas_student69': 141821, 'nb2canvas_student70': 141822, 'nb2canvas_student71': 141823, 'nb2canvas_student72': 141824, 'nb2canvas_student73': 141825, 'nb2canvas_student74': 141826, 'nb2canvas_student75': 141827, 'nb2canvas_student76': 141828, 'nb2canvas_student77': 141829, 'nb2canvas_student78': 141830, 'nb2canvas_student79': 141831, 'nb2canvas_student80': 141832, 'nb2canvas_student81': 141833, 'nb2canvas_student82': 141834, 'nb2canvas_student83': 141835, 'nb2canvas_student84': 141836, 'nb2canvas_student85': 141837, 'nb2canvas_student86': 141838, 'nb2canvas_student87': 141839, 'nb2canvas_student88': 141840, 'nb2canvas_student89': 141841, 'nb2canvas_student90': 141842, 'nb2canvas_student91': 141843, 'nb2canvas_student92': 141844, 'nb2canvas_student93': 141845, 'nb2canvas_student94': 141846, 'nb2canvas_student95': 141847, 'nb2canvas_student96': 141848, 'nb2canvas_student97': 141849, 'nb2canvas_student98': 141850, 'nb2canvas_student99': 141851, 'nb2canvas_student100': 141852, 'nb2canvas_student101': 143489, 'nb2canvas_student102': 143490, 'nb2canvas_student103': 143491, 'nb2canvas_student104': 143492, 'nb2canvas_student105': 143493, 'nb2canvas_student106': 143494, 'nb2canvas_student107': 143495, 'nb2canvas_student108': 143496, 'nb2canvas_student109': 143497, 'nb2canvas_student110': 143498, 'nb2canvas_student111': 143499, 'nb2canvas_student112': 143500, 'nb2canvas_student113': 143501, 'nb2canvas_student114': 143502, 'nb2canvas_student115': 143503, 'nb2canvas_student116': 143504, 'nb2canvas_student117': 143505, 'nb2canvas_student118': 143506, 'nb2canvas_student119': 143507, 'nb2canvas_student120': 143508, 'nb2canvas_student121': 143509, 'nb2canvas_student122': 143510, 'nb2canvas_student123': 143511, 'nb2canvas_student124': 143512, 'nb2canvas_student125': 143513, 'nb2canvas_student126': 143514, 'nb2canvas_student127': 143515, 'nb2canvas_student128': 143516, 'nb2canvas_student129': 143517, 'nb2canvas_student130': 143518, 'nb2canvas_student131': 143519, 'nb2canvas_student132': 143520, 'nb2canvas_student133': 143521, 'nb2canvas_student134': 143522, 'nb2canvas_student135': 143523, 'nb2canvas_student136': 143524, 'nb2canvas_student137': 143525, 'nb2canvas_student138': 143526, 'nb2canvas_student139': 143527, 'nb2canvas_student140': 143528, 'nb2canvas_student141': 143529, 'nb2canvas_student142': 143530, 'nb2canvas_student143': 143531, 'nb2canvas_student144': 143532, 'nb2canvas_student145': 143533, 'nb2canvas_student146': 143534, 'nb2canvas_student147': 143535, 'nb2canvas_student148': 143536, 'nb2canvas_student149': 143537, 'nb2canvas_student150': 143538, 'nb2canvas_student151': 143539, 'nb2canvas_student152': 143540, 'nb2canvas_student153': 143541, 'nb2canvas_student154': 143542, 'nb2canvas_student155': 143543, 'nb2canvas_student156': 143544, 'nb2canvas_student157': 143545, 'nb2canvas_student158': 143546, 'nb2canvas_student159': 143547, 'nb2canvas_student160': 143548, 'nb2canvas_student161': 143549, 'nb2canvas_student162': 143550, 'nb2canvas_student163': 143551, 'nb2canvas_student164': 143552, 'nb2canvas_student165': 143553, 'nb2canvas_student166': 143554, 'nb2canvas_student167': 143555, 'nb2canvas_student168': 143556, 'nb2canvas_student169': 143557, 'nb2canvas_student170': 143558, 'nb2canvas_student171': 143559, 'nb2canvas_student172': 143560, 'nb2canvas_student173': 143561, 'nb2canvas_student174': 143562, 'nb2canvas_student175': 143563, 'nb2canvas_student176': 143564, 'nb2canvas_student177': 143565, 'nb2canvas_student178': 143566, 'nb2canvas_student179': 143567, 'nb2canvas_student180': 143568, 'nb2canvas_student181': 143569, 'nb2canvas_student182': 143570, 'nb2canvas_student183': 143571, 'nb2canvas_student184': 143572, 'nb2canvas_student185': 143573, 'nb2canvas_student186': 143574, 'nb2canvas_student187': 143575, 'nb2canvas_student188': 143576, 'nb2canvas_student189': 143577, 'nb2canvas_student190': 143578, 'nb2canvas_student191': 143579, 'nb2canvas_student192': 143580, 'nb2canvas_student193': 143581, 'nb2canvas_student194': 143582, 'nb2canvas_student195': 143583, 'nb2canvas_student196': 143584, 'nb2canvas_student197': 143585, 'nb2canvas_student198': 143586, 'nb2canvas_student199': 143587, 'nb2canvas_student200': 143588, 'nb2canvas_student201': 143589, 'nb2canvas_student202': 143590, 'nb2canvas_student203': 143591, 'nb2canvas_student204': 143592, 'nb2canvas_student205': 143593, 'nb2canvas_student206': 143594, 'nb2canvas_student207': 143595, 'nb2canvas_student208': 143596, 'nb2canvas_student209': 143597, 'nb2canvas_student210': 143598, 'nb2canvas_student211': 143599, 'nb2canvas_student212': 143600, 'nb2canvas_student213': 143601, 'nb2canvas_student214': 143602, 'nb2canvas_student215': 143603, 'nb2canvas_student216': 143604, 'nb2canvas_student217': 143605, 'nb2canvas_student218': 143606, 'nb2canvas_student219': 143607, 'nb2canvas_student220': 143608, 'nb2canvas_student221': 143609, 'nb2canvas_student222': 143610, 'nb2canvas_student223': 143611, 'nb2canvas_student224': 143612, 'nb2canvas_student225': 143613, 'nb2canvas_student226': 143614, 'nb2canvas_student227': 143615, 'nb2canvas_student228': 143616, 'nb2canvas_student229': 143617, 'nb2canvas_student230': 143618, 'nb2canvas_student231': 143619, 'nb2canvas_student232': 143620, 'nb2canvas_student233': 143621, 'nb2canvas_student234': 143622, 'nb2canvas_student235': 143623, 'nb2canvas_student236': 143624, 'nb2canvas_student237': 143625, 'nb2canvas_student238': 143626, 'nb2canvas_student239': 143627, 'nb2canvas_student240': 143628, 'nb2canvas_student241': 143629, 'nb2canvas_student242': 143630, 'nb2canvas_student243': 143631, 'nb2canvas_student244': 143632, 'nb2canvas_student245': 143633, 'nb2canvas_student246': 143634, 'nb2canvas_student247': 143635, 'nb2canvas_student248': 143636, 'nb2canvas_student249': 143637, 'nb2canvas_student250': 143638, 'nb2canvas_student251': 143639, 'nb2canvas_student252': 143640, 'nb2canvas_student253': 143641, 'nb2canvas_student254': 143642, 'nb2canvas_student255': 143643, 'nb2canvas_student256': 143644, 'nb2canvas_student257': 143645, 'nb2canvas_student258': 143646, 'nb2canvas_student259': 143647, 'nb2canvas_student260': 143648, 'nb2canvas_student261': 143649, 'nb2canvas_student262': 143650, 'nb2canvas_student263': 143651, 'nb2canvas_student264': 143652, 'nb2canvas_student265': 143653, 'nb2canvas_student266': 143654, 'nb2canvas_student267': 143655, 'nb2canvas_student268': 143656, 'nb2canvas_student269': 143657, 'nb2canvas_student270': 143658, 'nb2canvas_student271': 143659, 'nb2canvas_student272': 143660, 'nb2canvas_student273': 143661, 'nb2canvas_student274': 143662, 'nb2canvas_student275': 143663, 'nb2canvas_student276': 143664, 'nb2canvas_student277': 143665, 'nb2canvas_student278': 143666, 'nb2canvas_student279': 143667, 'nb2canvas_student280': 143668, 'nb2canvas_student281': 143669, 'nb2canvas_student282': 143670, 'nb2canvas_student283': 143671, 'nb2canvas_student284': 143672, 'nb2canvas_student285': 143673, 'nb2canvas_student286': 143674, 'nb2canvas_student287': 143675, 'nb2canvas_student288': 143676, 'nb2canvas_student289': 143677, 'nb2canvas_student290': 143678, 'nb2canvas_student291': 143679, 'nb2canvas_student292': 143680, 'nb2canvas_student293': 143681, 'nb2canvas_student294': 143682, 'nb2canvas_student295': 143683, 'nb2canvas_student296': 143684, 'nb2canvas_student297': 143685, 'nb2canvas_student298': 143686, 'nb2canvas_student299': 143687, 'nb2canvas_student300': 143688, 'nb2canvas_student301': 143689, 'nb2canvas_student302': 143690, 'nb2canvas_student303': 143691, 'nb2canvas_student304': 143692, 'nb2canvas_student305': 143693, 'nb2canvas_student306': 143694, 'nb2canvas_student307': 143695, 'nb2canvas_student308': 143696, 'nb2canvas_student309': 143697, 'nb2canvas_student310': 143698, 'nb2canvas_student311': 143699, 'nb2canvas_student312': 143700, 'nb2canvas_student313': 143701, 'nb2canvas_student314': 143702, 'nb2canvas_student315': 143703, 'nb2canvas_student316': 143704, 'nb2canvas_student317': 143705, 'nb2canvas_student318': 143706, 'nb2canvas_student319': 143707, 'nb2canvas_student320': 143708, 'nb2canvas_student321': 143709, 'nb2canvas_student322': 143710, 'nb2canvas_student323': 143711, 'nb2canvas_student324': 143712, 'nb2canvas_student325': 143713, 'nb2canvas_student326': 143714, 'nb2canvas_student327': 143715, 'nb2canvas_student328': 143716, 'nb2canvas_student329': 143717, 'nb2canvas_student330': 143718, 'nb2canvas_student331': 143719, 'nb2canvas_student332': 143720, 'nb2canvas_student333': 143721, 'nb2canvas_student334': 143722, 'nb2canvas_student335': 143723, 'nb2canvas_student336': 143724, 'nb2canvas_student337': 143725, 'nb2canvas_student338': 143726, 'nb2canvas_student339': 143727, 'nb2canvas_student340': 143728, 'nb2canvas_student341': 143729, 'nb2canvas_student342': 143730, 'nb2canvas_student343': 143731, 'nb2canvas_student344': 143732, 'nb2canvas_student345': 143733, 'nb2canvas_student346': 143734, 'nb2canvas_student347': 143735, 'nb2canvas_student348': 143736, 'nb2canvas_student349': 143737, 'nb2canvas_student350': 143738, 'nb2canvas_student351': 143739, 'nb2canvas_student352': 143740, 'nb2canvas_student353': 143741, 'nb2canvas_student354': 143742, 'nb2canvas_student355': 143743, 'nb2canvas_student356': 143744, 'nb2canvas_student357': 143745, 'nb2canvas_student358': 143746, 'nb2canvas_student359': 143747, 'nb2canvas_student360': 143748, 'nb2canvas_student361': 143749, 'nb2canvas_student362': 143750, 'nb2canvas_student363': 143751, 'nb2canvas_student364': 143752, 'nb2canvas_student365': 143753, 'nb2canvas_student366': 143754, 'nb2canvas_student367': 143755, 'nb2canvas_student368': 143756, 'nb2canvas_student369': 143757, 'nb2canvas_student370': 143758, 'nb2canvas_student371': 143759, 'nb2canvas_student372': 143760, 'nb2canvas_student373': 143761, 'nb2canvas_student374': 143762, 'nb2canvas_student375': 143763, 'nb2canvas_student376': 143764, 'nb2canvas_student377': 143765, 'nb2canvas_student378': 143766, 'nb2canvas_student379': 143767, 'nb2canvas_student380': 143768, 'nb2canvas_student381': 143769, 'nb2canvas_student382': 143770, 'nb2canvas_student383': 143771, 'nb2canvas_student384': 143772, 'nb2canvas_student385': 143773, 'nb2canvas_student386': 143774, 'nb2canvas_student387': 143775, 'nb2canvas_student388': 143776, 'nb2canvas_student389': 143777, 'nb2canvas_student390': 143778, 'nb2canvas_student391': 143779, 'nb2canvas_student392': 143780, 'nb2canvas_student393': 143781, 'nb2canvas_student394': 143782, 'nb2canvas_student395': 143783, 'nb2canvas_student396': 143784, 'nb2canvas_student397': 143785, 'nb2canvas_student398': 143786, 'nb2canvas_student399': 143787, 'nb2canvas_student400': 143788, 'wuykimpang': 86959} 

student_grades = {115753: {'posted_grade': ''}, 141755: {'posted_grade': ''}, 141753: {'posted_grade': 0.0, 'text_comment': ''}, 141754: {'posted_grade': 6.0, 'text_comment': ''}}

existing_assignment = 'Test Assignment 2'

# Test data for test_grade_overview
expected_nbgrader_assignments = {'Test Assignment 1', 'Test Assignment 3', 'Test Assignment 2', 'assign1'}
expected_canvas_assignments = {192792: 'Week 1: Assignment', 192793: 'Week 2: Assignment', 192794: 'Week 3: Assignment', 192795: 'Week 4: Assignment', 192796: 'Week 5: Assignment [Peer Review]'}
expected_matches_names = {'Test Assignment 1', 'assign1', 'Test Assignment 3', 'Test Assignment 2'}


def wipe_db():
    # clear AssignmentStatus
    for match in AssignmentStatus.query.filter_by():
        db.session.delete(match)
    # wipe Test Assignment 1-3, and assign1
    canvas_wrapper = CanvasWrapper('https://canvas.ucsd.edu', {'canvas_user_id': '114217'})
    canvas = canvas_wrapper.get_canvas()
    course = canvas.get_course(20774)
    
    for assignment in course.get_assignments_for_group(92059):
        if not 'Week' in assignment.name:
            assignment.delete()

    db.session.commit()

def clear_grades():
    canvas_wrapper = CanvasWrapper('https://canvas.ucsd.edu', {'canvas_user_id': '114217'})
    canvas = canvas_wrapper.get_canvas()
    course = canvas.get_course(20774)
    users = course.get_recent_students()
    clear_grades = {user.id: {'posted_grade':''} for user in users}
    for assignment in course.get_assignments_for_group(92059):
        if assignment.published:
            try:
                progress = assignment.submissions_bulk_update(grade_data=clear_grades)
                timeout = time.time()+10
                while not progress.workflow_state == 'completed' and timeout > time.time():
                    progress = progress.query()
                    time.sleep(.1)
                    if progress.workflow_state == 'failed':
                        print('failed')
                        break
                print(assignment.name, progress.workflow_state)
            except:
                print(assignment.name)
